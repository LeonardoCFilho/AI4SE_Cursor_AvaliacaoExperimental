# Proposta de Testes de Integração – Fluxo Reserva

**Objetivo**: Validar o fluxo completo via API REST:
**Cadastro de hóspede → Criação de reserva → Atualização de disponibilidade do quarto**

---

## 1. Contexto e pré-requisitos

### 1.1 Requisitos atendidos (RF)

| RF   | Descrição |
|------|-----------|
| RF-02.1 | Cadastro de hóspede com nome, sobrenome, CPF e e-mail |
| RF-03.2 | Criar reservas associando quarto e hóspede |
| RF-04.1 | Impedir reserva de quarto ocupado ou em manutenção/limpeza |
| RF-04.2 | Atualizar disponibilidade do quarto ao criar/alterar/cancelar reserva |

### 1.2 Dependências para implementação

Os testes pressupõem que existam as rotas:

- `POST /api/hospedes` — cadastro de hóspede
- `POST /api/reservas` — criação de reserva
- `PATCH /api/quartos/:id/status` — alteração de status do quarto (já existe)
- `GET /api/quartos/:id` — consulta de quarto (já existe)

### 1.3 Stack de testes sugerida

- **supertest** — chamadas HTTP à API Express
- **Jest** — runner de testes (já configurado no stack1)
- Servidor HTTP em memória para evitar porta dedicada

---

## 2. Estratégia de teste

### 2.1 Escopo

Testes de **integração** que exercitam:

1. **API REST** (Controllers + rotas)
2. **Services** (lógica de negócio)
3. **Repositories** em memória (dados compartilhados no mesmo processo)
4. **Fluxo transacional** entre módulos (Hospede → Reserva → Quarto)

### 2.2 Dados compartilhados

- Um **Quarto** pré-cadastrado (status LIVRE)
- Dados de **Hóspede** válidos
- Dados de **Reserva** (quartoId, hospedeId, dataInicio, dataFim)

### 2.3 Sequência esperada

```
1. POST /api/quartos     → criar quarto (se não existir)
2. POST /api/hospedes    → cadastrar hóspede
3. GET  /api/quartos/:id → quarto com status LIVRE
4. POST /api/reservas    → criar reserva (quarto + hóspede)
5. GET  /api/quartos/:id → quarto com status OCUPADO
```

---

## 3. Casos de teste propostos

### 3.1 Fluxo feliz (happy path)

| ID   | Descrição | Pré-condições | Ações | Asserções |
|------|-----------|---------------|-------|-----------|
| IT-01 | Fluxo completo: cadastrar hóspede, criar reserva e verificar quarto OCUPADO | Quarto 101 cadastrado (LIVRE) | 1. POST hospede<br>2. POST reserva (quarto 101, hospede)<br>3. GET quarto 101 | 1. Hospede retorna 201 e id<br>2. Reserva retorna 201 e id<br>3. Quarto com status OCUPADO |

### 3.2 Regras de negócio (RF-04)

| ID   | Descrição | Pré-condições | Ações | Asserções |
|------|-----------|---------------|-------|-----------|
| IT-02 | Impedir reserva de quarto OCUPADO (RF-04.1) | Quarto 102 com status OCUPADO | POST reserva (quarto 102, hospede) | 400 Bad Request, mensagem indicando quarto indisponível |
| IT-03 | Impedir reserva de quarto em MANUTENCAO_LIMPEZA (RF-04.1) | Quarto 103 com status MANUTENCAO_LIMPEZA | POST reserva (quarto 103, hospede) | 400 Bad Request, quarto indisponível |
| IT-04 | Quarto LIVRE volta a LIVRE após cancelar reserva (RF-04.2) | Reserva ativa para quarto 104 | 1. PATCH reserva → cancelar<br>2. GET quarto 104 | 1. Reserva cancelada<br>2. Quarto com status LIVRE |

### 3.3 Validações e erros

| ID   | Descrição | Pré-condições | Ações | Asserções |
|------|-----------|---------------|-------|-----------|
| IT-05 | Reserva com quarto inexistente | Hospede cadastrado | POST reserva (quartoId: 99999, hospede) | 404 Not Found |
| IT-06 | Reserva com hóspede inexistente | Quarto cadastrado | POST reserva (quarto, hospedeId: 99999) | 404 Not Found |
| IT-07 | Cadastro de hóspede com dados inválidos | — | POST hospede (CPF inválido, email inválido) | 400 Bad Request |
| IT-08 | Reserva com data fim anterior à data início | Quarto e hospede cadastrados | POST reserva (dataFim < dataInicio) | 400 Bad Request |

### 3.4 Consistência entre módulos

| ID   | Descrição | Pré-condições | Ações | Asserções |
|------|-----------|---------------|-------|-----------|
| IT-09 | Reserva criada referencia quarto e hóspede corretos | Quarto 105 e hospede cadastrados | POST reserva → GET reserva | Campos quartoId, hospedeId corretos |
| IT-10 | Múltiplas reservas em quartos diferentes não interferem | 2 quartos LIVRE, 2 hospedes | 2x POST reserva (quarto1, hospede1) e (quarto2, hospede2) | Ambos quartos OCUPADO; reservas independentes |

---

## 4. Estrutura do arquivo de teste

```
stack1/
├── src/
│   └── __tests__/
│       └── integration/
│           └── fluxo-reserva.integration.test.ts
```

### 4.1 Template sugerido (pseudo-código)

```typescript
// fluxo-reserva.integration.test.ts
import request from 'supertest';
import { app } from '../../server';  // app Express exportável

describe('Fluxo de Integração: Cadastro → Reserva → Disponibilidade', () => {
  let quartoId: number;
  let hospedeId: number;

  beforeAll(async () => {
    // 1. Cadastrar quarto
    const resQuarto = await request(app)
      .post('/api/quartos')
      .send({ numero: '101', tipo: 'BASICO', capacidade: 2, precoDiaria: 150, status: 'LIVRE' });
    quartoId = resQuarto.body.id;

    // 2. Cadastrar hóspede
    const resHospede = await request(app)
      .post('/api/hospedes')
      .send({ nome: 'João', sobrenome: 'Silva', cpf: '12345678901', email: 'joao@email.com' });
    hospedeId = resHospede.body.id;
  });

  describe('Fluxo feliz', () => {
    it('IT-01: cadastrar hóspede → criar reserva → quarto fica OCUPADO', async () => {
      // GET quarto: status LIVRE
      const antes = await request(app).get(`/api/quartos/${quartoId}`);
      expect(antes.body.status).toBe('LIVRE');

      // POST reserva
      const resReserva = await request(app)
        .post('/api/reservas')
        .send({
          quartoId,
          hospedeId,
          dataInicio: '2025-02-10',
          dataFim: '2025-02-12'
        });
      expect(resReserva.status).toBe(201);

      // GET quarto: status OCUPADO
      const depois = await request(app).get(`/api/quartos/${quartoId}`);
      expect(depois.body.status).toBe('OCUPADO');
    });
  });

  describe('Regras RF-04', () => {
    it('IT-02: não permite reserva de quarto OCUPADO', async () => {
      // ... quarto já ocupado
      const res = await request(app).post('/api/reservas').send({ ... });
      expect(res.status).toBe(400);
      expect(res.body.erro).toMatch(/indisponível|ocupado/i);
    });
  });
});
```

---

## 5. Alterações necessárias no servidor

Para permitir testes de integração, o `server.ts` deve exportar o **app** Express sem chamar `listen()`:

```typescript
// server.ts
export const app = express();
// ... middlewares e rotas ...

// Só inicia servidor se executado diretamente
if (require.main === module) {
  app.listen(PORT, () => console.log(`API rodando em http://localhost:${PORT}`));
}
```

---

## 6. Resumo

| Aspecto | Proposta |
|---------|----------|
| **Tipo** | Testes de integração (API REST) |
| **Escopo** | Hospede + Reserva + Quarto (fluxo completo) |
| **Runner** | Jest |
| **Cliente HTTP** | supertest |
| **Dados** | Repositórios em memória (compartilhados) |
| **Casos** | 10 cenários (fluxo feliz, regras RF-04, validações, consistência) |

### Ordem de implementação sugerida

1. Refatorar `server.ts` para exportar `app`
2. Implementar módulos Hospede e Reserva (controllers, services, repositórios)
3. Instalar `supertest` e configurar testes de integração
4. Implementar os casos IT-01 a IT-10 conforme esta proposta
